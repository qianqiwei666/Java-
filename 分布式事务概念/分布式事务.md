# 一、概念

##  一、Base理论

> 1. 基本可用:当系统出现故障的时候,一部分业务可能造成不可用,但是要保证核心业务可用。
> 2. 软状态:任务之间正在执行中,当用户对其进行访问,访问的是任务的中间状态(稍等....)。交易:当用户进行支付的时候,系统正在进行数据同步,这时候用户访问的时候,给他 支付中的状态。
> 3. 最终一致:可能网络延迟,导致数据不能及时的同步,但是能保证最终的数据一致。

## 二、2PC

### 一、介绍

> 1. 意思:二阶段提交协议
> 2. 2:指的是两个阶段
> 3. P:指的是准备阶段
> 4. C:指的是提交阶段

### 二、用途

> MySQL,Oracle事务就是使用的二阶段提交。

### 三、流程

#### 一、概要

> 1. 模拟两个数据库:资源一,资源二。
> 2. 资源一:负责减少库存。
> 3. 资源二:负责减少金额。

#### 二、执行分布式事务

> 1. 阶段一(准备阶段):事务管理器(TM)分别向资源一资源二发送准备消息,分别开启本地事务执行业务并记录undoLog/redoLog,业务执行完成返回ACK给事务管理器。
> 2. 阶段二(提交阶段):事务管理器(TM)接收到所有的ACK之后分别向资源一资源二发送提交事务消息(commit),如果资源一资源二全部返回ACK分布式事务执行成功。
> 3. 只要阶段一,阶段二失败了:事务管理器就发送回滚消息给资源一资源二。
> 4. 分布式事务执行完成。

## 三、XA方案

### 一、介绍

> 1. XA方案基于2PC协议规范化方案。
> 2. AP:即应用程序
> 3. RM:资源管理器也就是事务参与者,资源管理器主要控制分支事务。
> 4. TM:事务管理器负责协调事务,保证全局事务的原子性。

### 二、执行流程

> 1. AP通知TM执行事务
> 2. 进入准备阶段:
> 3. TM将准备状态发送给所有的参与者(RM)。数据库资源锁定。
> 4. 参与者开启事务,执行业务后返回ACK。
> 5. 进入提交阶段:
> 6. TM接收到所有的ACK并向所有的参与者(RM)发送提交命令,当所有的参与者返回ACK之后,分布式事务执行结束。

### 三、缺点

> 需要等待所有的参与者提交事务之后,锁得到释放,性能较差

## 四、TCC

### 一、介绍

> 1. Try阶段是做业务检查（一致性）及资源预留（隔离），此阶段仅是一个初步操作，它和后续的Confirm一起才能真正构成一个完整的业务逻辑。
> 2. Confirm阶段是做确认提交，Try阶段所有分支事务执行成功后开始执行Confirm。通常情况下，采用TCC则认为Confirm阶段是不会出错的。即 ：只要Try成功，Confirm一定成功。若Confirm阶段真的出错了，需引入重试机制或人工处理。
> 3. Cancel阶段是在业务执行错误需要回滚的状态下执行分支事务的业务取消，预留资源释放。通常情况下，采用TCC则认为Cancel阶段也是一定成功的。若Cancel阶段真的出错了，需引入重试机制或人工处理。





